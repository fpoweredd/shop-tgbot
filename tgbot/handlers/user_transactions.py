# - *- coding: utf- 8 - *-
from aiogram.dispatcher import FSMContext
from aiogram.types import CallbackQuery, Message

from tgbot.data.loader import dp
from tgbot.keyboards.inline_user import refill_bill_finl, refill_choice_finl, refill_bill_yoomoney, paymanual_support, paymanual_finl, paymanual_admin_finl, refill_bill_payok
from tgbot.services.api_qiwi import QiwiAPI
from tgbot.services.api_sqlite import update_userx, get_refillx, add_refillx, get_userx
from tgbot.services.sqlite_logic import get_data_payok
from tgbot.services.json_logic import get_texts
from tgbot.utils.const_functions import get_date, get_unix
from tgbot.utils.misc_functions import send_admins
from tgbot.services.yoomoney_api import generate_payment, check_payment, get_receipt
from tgbot.utils.const_functions import ded
from tgbot.data.loader import bot


from payok import payok_api
import random


min_input_qiwi = 10  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –≤ —Ä—É–±–ª—è—Ö


# –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
@dp.callback_query_handler(text="user_refill", state="*")
async def refill_way(call: CallbackQuery, state: FSMContext):
    get_kb = refill_choice_finl()

    if get_kb is not None:
        await call.message.edit_text("<b>üí∞ –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</b>", reply_markup=get_kb)
    else:
        await call.answer("‚õî –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ", True)

# –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
@dp.callback_query_handler(text_startswith="refill_choice", state="*")
async def refill_way_choice(call: CallbackQuery, state: FSMContext):
    get_way = call.data.split(":")[1]

    await state.update_data(here_pay_way=get_way)
    await state.set_state("here_pay_amount")
    await call.message.edit_text("<b>üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</b>")

@dp.callback_query_handler(text_startswith="refill_yoomoney", state="*")
async def refill_way_yoomoney(call: CallbackQuery, state: FSMContext):
    await state.set_state("here_pay_amount_yoomoney")
    await call.message.edit_text("<b>üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</b>")

@dp.callback_query_handler(text_startswith="refill_payok", state="*")
async def refill_way_yoomoney(call: CallbackQuery, state: FSMContext):
    await state.set_state("here_pay_amount_payok")
    await call.message.edit_text("<b>üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</b>")



###################################################################################
#################################### –í–í–û–î –°–£–ú–ú–´ ###################################
# –ü—Ä–∏–Ω—è—Ç–∏–µ —Å—É–º–º—ã –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ —á–µ—Ä–µ–∑ QIWI
@dp.message_handler(state="here_pay_amount")
async def refill_get(message: Message, state: FSMContext):
    if message.text.isdigit():
        cache_message = await message.answer("<b>‚ôª –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–ª–∞—Ç—ë–∂ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...</b>")
        pay_amount = int(message.text)

        if min_input_qiwi <= pay_amount <= 300000:
            get_way = (await state.get_data())['here_pay_way']
            await state.finish()

            get_message, get_link, receipt = await (
                await QiwiAPI(cache_message, user_bill_pass=True)
            ).bill_pay(pay_amount, get_way)

            if get_message:
                await cache_message.edit_text(get_message, reply_markup=refill_bill_finl(get_link, receipt, get_way))
        else:
            await cache_message.edit_text(f"<b>‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</b>\n"
                                          f"‚ñ∂ C—É–º–º–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ <code>{min_input_qiwi}‚ÇΩ</code> –∏ –±–æ–ª—å—à–µ <code>300 000‚ÇΩ</code>\n"
                                          f"üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤")
    else:
        await message.answer("<b>‚ùå –î–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –≤–≤–µ–¥–µ–Ω—ã –Ω–µ–≤–µ—Ä–Ω–æ.</b>\n"
                             "üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤")

@dp.message_handler(state="here_pay_amount_yoomoney")
async def refill_get_yoomoney(message: Message, state: FSMContext):
    if message.text.isdigit():
        cache_message = await message.answer("<b>‚ôª –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–ª–∞—Ç—ë–∂ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...</b>")
        pay_amount = int(message.text)

        if min_input_qiwi <= pay_amount <= 300000:
            label = str(message.from_user.id + random.randint(1000, 9999))

            message_url = generate_payment(pay_amount, label)
            message_text =  ded(f"""<b>üí∞ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</b>
                               ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ
                               üíµ –î–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ 
                               <code>–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</code> –∏ –æ–ø–ª–∞—Ç–∏—Ç–µ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –≤–∞–º —Å—á—ë—Ç
                               ‚ùó –í—Ä–µ–º—è –Ω–∞ –æ–ø–ª–∞—Ç—É –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ.
                               üí∞ –°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: <code>{pay_amount}‚ÇΩ</code>
                               ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ
                               üîÑ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ <code>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É</code>""")
            await state.finish()
            await cache_message.edit_text(message_text, reply_markup=refill_bill_yoomoney(pay_amount, label, message_url))
        else:
            await cache_message.edit_text(f"<b>‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</b>\n"
                                          f"‚ñ∂ C—É–º–º–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ <code>{min_input_qiwi}‚ÇΩ</code> –∏ –±–æ–ª—å—à–µ <code>300 000‚ÇΩ</code>\n"
                                          f"üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤")
    else:
        await message.answer("<b>‚ùå –î–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –≤–≤–µ–¥–µ–Ω—ã –Ω–µ–≤–µ—Ä–Ω–æ.</b>\n"
                             "üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤")

@dp.message_handler(state="here_pay_amount_payok")
async def refill_get_payok(message: Message, state: FSMContext):
    if message.text.isdigit():
        cache_message = await message.answer("<b>‚ôª –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–ª–∞—Ç—ë–∂ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...</b>")
        pay_amount = int(message.text)

        if min_input_qiwi <= pay_amount <= 300000:
            label = str(message.from_user.id + random.randint(1000, 9999))
            print(len(label))
            data = get_data_payok()
            print(data)

            message_url = payok_api.createPay(
                secret=data[2],
                amount=pay_amount,
                payment=label,
                shop=int(data[3]),
                desc="–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞"

            )
            message_text =  ded(f"""<b>üí∞ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</b>
                               ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ
                               üíµ –î–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ 
                               <code>–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</code> –∏ –æ–ø–ª–∞—Ç–∏—Ç–µ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –≤–∞–º —Å—á—ë—Ç
                               ‚ùó –í—Ä–µ–º—è –Ω–∞ –æ–ø–ª–∞—Ç—É –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ.
                               üí∞ –°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: <code>{pay_amount}‚ÇΩ</code>
                               ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ
                               üîÑ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ <code>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É</code>""")
            await state.finish()
            await cache_message.edit_text(message_text, reply_markup=refill_bill_payok(pay_amount, label, message_url))
        else:
            await cache_message.edit_text(f"<b>‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</b>\n"
                                          f"‚ñ∂ C—É–º–º–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ <code>{min_input_qiwi}‚ÇΩ</code> –∏ –±–æ–ª—å—à–µ <code>300 000‚ÇΩ</code>\n"
                                          f"üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤")
    else:
        await message.answer("<b>‚ùå –î–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –≤–≤–µ–¥–µ–Ω—ã –Ω–µ–≤–µ—Ä–Ω–æ.</b>\n"
                             "üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤")


###################################################################################
################################ –ü–†–û–í–ï–†–ö–ê –ü–õ–ê–¢–ï–ñ–ï–ô ################################
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É
@dp.callback_query_handler(text_startswith="Pay:Form")
async def refill_check_form(call: CallbackQuery):
    receipt = call.data.split(":")[2]

    pay_status, pay_amount = await (
        await QiwiAPI(call, user_check_pass=True)
    ).check_form(receipt)

    if pay_status == "PAID":
        get_refill = get_refillx(refill_receipt=receipt)
        if get_refill is None:
            await refill_success(call, receipt, pay_amount, "Form", None)
        else:
            await call.answer("‚ùó –í–∞—à–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —É–∂–µ –±—ã–ª–æ –∑–∞—á–∏—Å–ª–µ–Ω–æ.", True)
    elif pay_status == "EXPIRED":
        await call.message.edit_text("<b>‚ùå –í—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã –≤—ã—à–ª–æ. –ü–ª–∞—Ç—ë–∂ –±—ã–ª —É–¥–∞–ª—ë–Ω.</b>")
    elif pay_status == "WAITING":
        await call.answer("‚ùó –ü–ª–∞—Ç—ë–∂ –Ω–µ –±—ã–ª –Ω–∞–π–¥–µ–Ω.\n"
                          "‚åõ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á—É—Ç—å –ø–æ–∑–∂–µ.", True, cache_time=5)
    elif pay_status == "REJECTED":
        await call.message.edit_text("<b>‚ùå –°—á—ë—Ç –±—ã–ª –æ—Ç–∫–ª–æ–Ω—ë–Ω.</b>")

#–ü–†–û–í–ï–†–ö–ê –ü–õ–ê–¢–ï–ñ–ê –Æ–ú–ê–ù–ò
@dp.callback_query_handler(text_startswith="Pay_yoomoney:")
async def refill_check_yoomoney(call: CallbackQuery):
    label = call.data.split(":")[1]
    amount = int(call.data.split(":")[2])
    result =  check_payment(label)
    get_user = get_userx(user_id=call.from_user.id)
    if result == False:
        await call.answer("‚ùó –ü–ª–∞—Ç—ë–∂ –Ω–µ –±—ã–ª –Ω–∞–π–¥–µ–Ω.\n"
                          "‚åõ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á—É—Ç—å –ø–æ–∑–∂–µ.", True, cache_time=5)
    else:
        receipt = get_receipt()
        await call.message.delete()
        await refill_success(call, receipt, amount, "YooMoney", None)

@dp.callback_query_handler(text_startswith="Pay_payok:")
async def refill_check_payok(call: CallbackQuery):
    label = call.data.split(":")[1]
    amount = int(call.data.split(":")[2])
    result =  check_payment(label)
    get_user = get_userx(user_id=call.from_user.id)

    data = get_data_payok()

    payment_id = call.data.split(":")[1]
    check = payok_api.getTransaction(
            API_ID=data[1],
            API_KEY=data[0],
            shop=int(data[3]),
            payment=payment_id)

    if check['status'] != "success":
        await call.answer("‚ùó –ü–ª–∞—Ç—ë–∂ –Ω–µ –±—ã–ª –Ω–∞–π–¥–µ–Ω.\n"
                          "‚åõ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á—É—Ç—å –ø–æ–∑–∂–µ.", True, cache_time=5)
    else:
        receipt = get_receipt()
        await call.message.delete()
        await refill_success(call, receipt, amount, "Payok", None)




# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã –ø–æ –ø–µ—Ä–µ–≤–æ–¥—É (–ø–æ –Ω–∏–∫—É –∏–ª–∏ –Ω–æ–º–µ—Ä—É)
@dp.callback_query_handler(text_startswith=['Pay:Number', 'Pay:Nickname'])
async def refill_check_send(call: CallbackQuery):
    way_pay = call.data.split(":")[1]
    receipt = call.data.split(":")[2]

    pay_status, pay_amount = await (
        await QiwiAPI(call, user_check_pass=True)
    ).check_send(receipt)

    if pay_status == 1:
        await call.answer("‚ùó –û–ø–ª–∞—Ç–∞ –±—ã–ª–∞ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ –Ω–µ –≤ —Ä—É–±–ª—è—Ö.", True, cache_time=5)
    elif pay_status == 2:
        await call.answer("‚ùó –ü–ª–∞—Ç—ë–∂ –Ω–µ –±—ã–ª –Ω–∞–π–¥–µ–Ω.\n"
                          "‚åõ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á—É—Ç—å –ø–æ–∑–∂–µ.", True, cache_time=5)
    elif pay_status == 4:
        pass
    else:
        get_refill = get_refillx(refill_receipt=receipt)
        if get_refill is None:
            await refill_success(call, receipt, pay_amount, way_pay, None)
        else:
            await call.answer("‚ùó –í–∞—à–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —É–∂–µ –∑–∞—á–∏—Å–ª–µ–Ω–æ.", True, cache_time=60)


##########################################################################################
######################################### –ü–†–û–ß–ï–ï #########################################
# –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤
async def refill_success(call: CallbackQuery, receipt, amount, get_way, user_id_second):
    if user_id_second == None:
        get_user = get_userx(user_id=call.from_user.id)
    else:
        get_user = get_userx(user_id=user_id_second)

    add_refillx(get_user['user_id'], get_user['user_login'], get_user['user_name'], receipt,
                amount, receipt, get_way, get_date(), get_unix())

    if user_id_second == None:
        update_userx(call.from_user.id,
                     user_balance=get_user['user_balance'] + amount,
                     user_refill=get_user['user_refill'] + amount)
        await bot.send_message(call.from_user.id,   f"<b>üí∞ –í—ã –ø–æ–ø–æ–ª–Ω–∏–ª–∏ –±–∞–ª–∞–Ω—Å –Ω–∞ —Å—É–º–º—É <code>{amount}‚ÇΩ</code>. –£–¥–∞—á–∏ ‚ù§\n üßæ –ß–µ–∫: <code>#{receipt}</code></b>")


    else:
        update_userx(user_id_second,
                     user_balance=get_user['user_balance'] + amount,
                     user_refill=get_user['user_refill'] + amount)

        await bot.send_message(user_id_second,
                               f"<b>üí∞ –í—ã –ø–æ–ø–æ–ª–Ω–∏–ª–∏ –±–∞–ª–∞–Ω—Å –Ω–∞ —Å—É–º–º—É <code>{amount}‚ÇΩ</code>. –£–¥–∞—á–∏ ‚ù§\n üßæ –ß–µ–∫: <code>#{receipt}</code></b>")

    await send_admins(
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <b>@{get_user['user_login']}</b> | <a href='tg://user?id={get_user['user_id']}'>{get_user['user_name']}</a> | <code>{get_user['user_id']}</code>\n"
        f"üí∞ –°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: <code>{amount}‚ÇΩ</code>\n"
        f"üßæ –ß–µ–∫: <code>#{receipt}</code>"
    )

# –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
@dp.callback_query_handler(text="paymanual", state="*")
async def paymanual_way(call: CallbackQuery, state: FSMContext):
    message_text = get_texts('faq')
    await call.message.edit_text(f" <i>–í–≤–µ–¥–∏—Ç–µ –∂–µ–ª–∞–µ–º—É—é —Å—É–º–º—É –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞</i>", reply_markup = paymanual_support())
    await state.set_state("here_pay_amount_paymanual")

@dp.message_handler(state="here_pay_amount_paymanual")
async def paymanual_get(message: Message, state: FSMContext):
    if message.text.isdigit():
        pay_amount = int(message.text)
        if min_input_qiwi <= pay_amount <= 300000:
            await state.set_state("paymanual_finish")
            message_text = get_texts('faq')
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            username = message.from_user.username
            if not username:
                username = str(message.from_user.id)
                
            await state.update_data(username=username)
            
            await message.answer(ded(f"""<b>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</b>
                                    ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ
                                    {message_text}
                                    üí∞ –°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: <code>{pay_amount}</code><code>‚ÇΩ</code>
                                    üí¨ –£–∫–∞–∂–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: <code>{username}</code>
                                    ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ
                                    üîÑ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É ‚Üì"""),
                                    reply_markup = paymanual_finl(pay_amount, message.from_user.id))
        else:
            await message.answer(f"<b>‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</b>\n"
                                          f"‚ñ∂ C—É–º–º–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ <code>{min_input_qiwi}‚ÇΩ</code> –∏ –±–æ–ª—å—à–µ <code>300 000‚ÇΩ</code>\n"
                                          f"üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤")
    else:
        await message.answer("<b>‚ùå –î–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –≤–≤–µ–¥–µ–Ω—ã –Ω–µ–≤–µ—Ä–Ω–æ.</b>\n"
                             "üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤")


@dp.callback_query_handler(text_startswith="paymanual_final:", state="paymanual_finish")
async def paymanual_final(call: CallbackQuery, state: FSMContext):
    pay_amount = int(call.data.split(":")[1])
    id = call.data.split(":")[2]

    async with state.proxy() as data:
        username = data['username']

    if username:
        username_text = f"@{username}"
    else:
        username_text = f"<a href='tg://user?id={call.from_user.id}'>ID: {call.from_user.id}</a>"

    message_text = (f"‚ùì {username_text} –ø–æ–ø–æ–ª–Ω–∏–ª –±–∞–ª–∞–Ω—Å –Ω–∞ <b>{pay_amount}</b> ‚ÇΩ ‚ùì")

    await send_admins(f"‚ùì {username_text} –ø–æ–ø–æ–ª–Ω–∏–ª –±–∞–ª–∞–Ω—Å –Ω–∞ <b>{pay_amount}</b> ‚ÇΩ ‚ùì", paymanual_admin_finl(pay_amount, id))
    await state.finish()
    await call.message.edit_text("<b>–£—Å–ø–µ—à–Ω–æ</b>")


@dp.callback_query_handler(text_startswith="paymanual_admin:", state="*")
async def paymanual_admin(call: CallbackQuery, state: FSMContext):
    selected = call.data.split(":")[1]
    pay_amount = int(call.data.split(":")[2])

    id = int(call.data.split(":")[3])

    if selected == 'yes':
        receipt = get_receipt()
        await refill_success(call, receipt, pay_amount, "paymanual", id)
    else:
        await bot.send_message(id, "<b>–í–∞—à–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–∏–ª–∏.</b> –ï—Å–ª–∏ —É –≤–∞—Å –æ—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã, —Ç–æ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É.")

